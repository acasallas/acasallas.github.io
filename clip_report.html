<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Alan Casallas</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- Custom styles for this template -->
    <link href="css/clean-blog.min.css" rel="stylesheet">
    
    <!-- Custom CSS overrides -->
    <link href="css/mycss.css" rel="stylesheet">

  </head>

  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand" href="index.html">Main Page</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          Menu
          <i class="fa fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="projects.html">Projects</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="alan_casallas_resume.pdf">Resume</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <style>
  .projectimg {
    display: inline;
    float:left;
    padding:10px;
    border-radius:10%;
  }
</style>

    <!-- Page Header -->
    <header class="masthead" style="background-color: white">
      <div class="overlay"></div>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <div class="page-heading">
              <h1>CLIP Report</h1>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="col-lg-8 col-md-10 mx-auto">
    <p>
      Please see the <a href="https://github.com/acasallas/clip-ablation-study">GitHub Repo.</a>
    </p>

    <p>
      I created a custom implementation of CLIP. I did both to explore what effect replacing a transformer with an RNN would have as the text encoder, as well as to explore how rich embeddings trained on a home GPU (Nvidia 4090) could be. 
      TODO (these sections have not yet been written): 
      Motivation
      Trying to use an RNN as the text encoder
      Collecting Data
      img2dataset, datacomp, cc3m
      Talk about how you couldn't use gradient accumulation.
      XBM queue, 2048 batch size
      Initial Faillures
      Training
      Zero Shot Results
      Use an XBM queue in the future?

    
  </p>
  <p>When OpenAI trained CLIP, their smallest model was trained with a batch size of 32,768. In many deep learning problems, the loss function is an average of each individual sample's loss with respect to a true answer, and so to achieve a large effective batch size, it is possible to calculate loss for a smaller "micro batch" of samples and simply sum the results to calculate the loss for a larger effective batch. In CLIP however, the loss is not an average of individual samples, but rather is contrastive in nature and is thus a comparison of each pair of samples, making it less obvious how to calculate the loss for a large effective batch.</p>
  <img src="img/clip_loss.png" height="300">
  <p>With my model and data setup, I was able to fit a 2048 sample batch size in my GPU. To try to achieve a larger effective batch size, I implemented an XBM queue of size 2048, saving the most recent embeddings in the queue so they could be appended to the 256 items in the current batch for loss calculation.</p>
  <p>Intially when I began training with this setup, the network failed to learn, even after trying a variety of learning rates. The network only started to learn after I removed the XBM queue. It appears that having an XBM queue made it difficult for my network to learn, either due to the sheer size of the embeddings, or, more likely, because the network was not responding well to having stale embeddings in its loss function. Once I removed the XBM queue, the network started to learn, as can be seen from the wandb plots below.</p> 
  
  <img src="img/clip_training.png" height="300">
  <p>While all training from this point on was done without the XBM queue, a path for further experimentation could be to gradually introduce an XBM TODO: continue and also mention MoCo.</p>

    <hr>

    <!-- Footer -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <ul class="list-inline text-center">
              <li class="list-inline-item">
                <a href="https://www.facebook.com/alan.casallas.7">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="https://github.com/acasallas">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="https://www.linkedin.com/in/alancasallas/">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                </span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Custom scripts for this template -->
    <script src="js/clean-blog.min.js"></script>

  </body>

</html>
